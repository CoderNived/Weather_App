<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Weather + ML Prediction App</title>

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" />

    <style>
        /* ML Prediction Button */
        .predict-btn {
            background: #22c55e;
            color: white;
            padding: 10px 16px;
            border-radius: 10px;
            font-size: 0.95rem;
            cursor: pointer;
            border: none;
            margin-bottom: 10px;
            transition: 0.2s;
        }
        .predict-btn:hover {
            background: #16a34a;
            transform: translateY(-1px);
        }

        /* ML Output Box */
        .prediction-box {
            background: #0b1120;
            border: 1px solid #1e293b;
            padding: 14px;
            border-radius: 12px;
            margin-bottom: 12px;
            display: none;
        }
        .prediction-box h3 {
            margin-bottom: 8px;
            font-size: 1rem;
        }
        .prediction-box ul {
            list-style: none;
            padding-left: 0;
        }
        .prediction-box li {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }

        /* Main App Styling */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: system-ui, sans-serif; }

        body {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle at top, #1d4ed8, #020617);
            color: #e5e7eb;
        }

        .app-wrapper {
            width: 95%;
            max-width: 960px;
            background: rgba(15, 23, 42, 0.95);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.6);
        }

        .app-header {
            display: flex; flex-wrap: wrap; justify-content: space-between; gap: 16px;
            margin-bottom: 20px;
        }

        .brand { display: flex; align-items: center; gap: 12px; }
        .brand-logo {
            width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border-radius: 12px; font-size: 24px;
        }

        .weather-input { display: flex; gap: 10px; flex-wrap: wrap; }
        .weather-input input {
            padding: 10px; background: #020617; border: 1px solid #4b5563;
            color: white; border-radius: 999px;
        }

        .weather-input button {
            padding: 9px 14px; border-radius: 999px; cursor: pointer; border: none;
            display: flex; align-items: center; gap: 6px;
        }
        #SearchBtn { background: #2563eb; color: white; }
        #SearchBtn:hover { background: #1d4ed8; }
        #locationBtn { background: #020617; border: 1px solid #4b5563; color: white; }

        .weather-data { display: flex; gap: 18px; }
        .weather-left { flex: 1.1; }
        .weather-right { flex: 1; display: flex; flex-direction: column; gap: 12px; }

        .card {
            background: radial-gradient(circle at top left, #1f2937 0, #020617 55%);
            padding: 18px; border-radius: 18px;
        }
        #temp { font-size: 3rem; font-weight: 700; }
        .weather-icon img { width: 90px; }

        .forecast-row {
            background: #0b1120; padding: 8px; border-radius: 12px;
            display: flex; justify-content: space-between; align-items: center;
        }

        .details-list { list-style: none; display: flex; flex-direction: column; gap: 6px; }

        @media (max-width: 720px) {
            .weather-data { flex-direction: column; }
        }
    </style>
</head>

<body>
    <div class="app-wrapper">

        <!-- HEADER -->
        <header class="app-header">
            <div class="brand">
                <div class="brand-logo"><i class="fas fa-cloud-sun"></i></div>
                <div>
                    <h1>Weather Now</h1>
                    <p>Real-time weather + ML Prediction</p>
                </div>
            </div>

            <form class="weather-input" onsubmit="return false;">
                <input id="city_input" type="text" placeholder="Enter city name" />
                <button id="SearchBtn"><i class="fa-solid fa-search"></i> Search</button>
                <button id="locationBtn"><i class="bx bx-target-lock"></i> Current</button>
            </form>
        </header>

        <!-- MAIN -->
        <section class="weather-data">

            <!-- LEFT -->
            <section class="weather-left">
                <article class="card">
                    <div class="current-weather">
                        <div>
                            <p style="opacity:.6">Now</p>
                            <h2 id="temp">--°C</h2>
                            <p id="weatherDesc">----</p>
                        </div>
                        <div class="weather-icon"><img id="weatherIcon" /></div>
                    </div>
                    <hr>
                    <footer class="card-footer">
                        <p><i class="fa-regular fa-calendar"></i> <span id="date">--</span></p>
                        <p><i class="fa-solid fa-location-dot"></i> <span id="location">--</span></p>
                    </footer>
                </article>
            </section>

            <!-- RIGHT -->
            <aside class="weather-right">

                <!-- ML Predict Button -->
                <button id="predictBtn" class="predict-btn">
                    <i class="fa-solid fa-robot"></i> Predict Weather Report
                </button>

                <!-- ML Output -->
                <div id="predictionBox" class="prediction-box">
                    <h3>ML Prediction Output</h3>
                    <ul id="predictionResult"></ul>
                </div>

                <!-- Forecast -->
                <article class="mini-card">
                    <h3>5-Day Forecast</h3>
                    <div id="forecastContainer"></div>
                </article>

                <!-- Details -->
                <article class="mini-card">
                    <h3>Details</h3>
                    <ul class="details-list">
                        <li><span>Feels like</span> <strong id="feelsLike">--°C</strong></li>
                        <li><span>Humidity</span> <strong id="humidity">--%</strong></li>
                        <li><span>Wind</span> <strong id="wind">-- m/s</strong></li>
                    </ul>
                </article>

            </aside>
        </section>
    </div>


    <!-- JAVASCRIPT -->
    <script>
        const apiKey = "6c5642e7e476b31a7d5d77ef8c5357d3";

        const cityInput = document.getElementById("city_input");
        const searchBtn = document.getElementById("SearchBtn");
        const locationBtn = document.getElementById("locationBtn");

        function showError(msg) { alert(msg); }


        /* -----------------------------
           Weather Search + Geolocation
        ------------------------------*/
        searchBtn.addEventListener("click", () => {
            const city = cityInput.value.trim();
            if (!city) return showError("Enter a city name!");
            getWeather(city);
        });

        cityInput.addEventListener("keyup", e => {
            if (e.key === "Enter") searchBtn.click();
        });

        locationBtn.addEventListener("click", () => {
            navigator.geolocation.getCurrentPosition(pos => {
                getWeatherByCoordinates(pos.coords.latitude, pos.coords.longitude);
            }, () => showError("Enable location access."));
        });


        async function getWeather(city) {
            const url = `https://api.openweathermap.org/data/2.5/weather?q=${city}&units=metric&appid=${apiKey}`;
            const res = await fetch(url);

            if (!res.ok) return showError("City not found.");

            const data = await res.json();
            updateUI(data);
            getFiveDayForecast(data.name);
        }


        async function getWeatherByCoordinates(lat, lon) {
            const url = 
            `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&appid=${apiKey}`;
            const res = await fetch(url);
            const data = await res.json();

            updateUI(data);
            getFiveDayForecast(data.name);
        }


        function updateUI(data) {
            document.getElementById("temp").innerText = Math.round(data.main.temp) + "°C";
            document.getElementById("weatherDesc").innerText = data.weather[0].description;
            document.getElementById("weatherIcon").src =
                `https://openweathermap.org/img/wn/${data.weather[0].icon}@2x.png`;

            document.getElementById("location").innerText =
                `${data.name}, ${data.sys.country}`;
            document.getElementById("date").innerText = new Date().toDateString();

            document.getElementById("feelsLike").innerText = 
                Math.round(data.main.feels_like) + "°C";
            document.getElementById("humidity").innerText = data.main.humidity + "%";
            document.getElementById("wind").innerText = data.wind.speed + " m/s";
        }


        /* -----------------------------
           Forecast API
        ------------------------------*/
        async function getFiveDayForecast(city) {
            const url = 
            `https://api.openweathermap.org/data/2.5/forecast?q=${city}&units=metric&appid=${apiKey}`;
            
            const res = await fetch(url);
            const data = await res.json();

            const cont = document.getElementById("forecastContainer");
            cont.innerHTML = "";

            const map = {};
            data.list.forEach(i => {
                const date = i.dt_txt.split(" ")[0];
                if (!map[date]) map[date] = i;
            });

            Object.values(map).slice(0, 5).forEach(item => {
                cont.innerHTML += `
                <div class="forecast-row">
                    <div class="forecast-left">
                        <p>${new Date(item.dt_txt).toLocaleDateString("en-US", { weekday: "short" })}</p>
                        <img src="https://openweathermap.org/img/wn/${item.weather[0].icon}.png">
                    </div>
                    <p>${Math.round(item.main.temp)}°C</p>
                    <p style="opacity:.7">${item.weather[0].description}</p>
                </div>`;
            });
        }


        /* -----------------------------
           ML Prediction Button
        ------------------------------*/
        document.getElementById("predictBtn").addEventListener("click", predictWeatherReport);

        async function predictWeatherReport() {

            const temp = parseFloat(document.getElementById("temp").innerText);
            const humidity = parseFloat(document.getElementById("humidity").innerText);
            const wind = parseFloat(document.getElementById("wind").innerText);

            // dummy values for missing sensors
            const vibration = 0.5;
            const pressure = 1010;

            const body = { temp, humidity, vibration, pressure };

            try {
                const res = await fetch("/predict", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(body)
                });

                const data = await res.json();

                if (data.error) return alert("ML Error: " + data.error);

                const box = document.getElementById("predictionBox");
                const list = document.getElementById("predictionResult");

                box.style.display = "block";
                list.innerHTML = "";

                for (let model in data) {
                    list.innerHTML += `<li><strong>${model}: </strong> ${data[model].toFixed(2)}</li>`;
                }

            } catch (err) {
                console.error(err);
                alert("Prediction Failed.");
            }
        }


        window.addEventListener("DOMContentLoaded", () => getWeather("Mumbai"));
    </script>

</body>
</html>
